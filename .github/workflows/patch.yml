name: Auto Build and Release ReVanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'

jobs:
  download-tools:
    name: Download ReVanced Tools
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.cache-key }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11
      
      - name: Download ReVanced Tools
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Download tools once (this avoids rate limits in matrix)
          mkdir -p tools
          
          # Download revanced-cli
          curl -L "https://github.com/revanced/revanced-cli/releases/latest/download/revanced-cli-all.jar" -o tools/revanced-cli.jar
          
          # Download revanced-patches
          curl -L "https://github.com/revanced/revanced-patches/releases/latest/download/patches.jar" -o tools/patches.jar
          
          # Download integrations (optional)
          curl -L "https://github.com/revanced/revanced-integrations/releases/latest/download/app-release-unsigned.apk" -o tools/integrations.apk
          
          echo "Tools downloaded successfully"
          ls -la tools/
      
      - name: Cache Tools
        uses: actions/cache@v3
        id: cache-tools
        with:
          path: tools/
          key: revanced-tools-${{ hashFiles('patch-config.json') }}
      
      - name: Generate Cache Key
        id: cache-key
        run: echo "cache-key=${{ steps.cache-tools.outputs.cache-key || 'no-cache' }}" >> $GITHUB_OUTPUT

  check-updates:
    name: Check for Updates
    needs: download-tools
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Always Build
        id: check
        run: |
          echo "has_updates=true" >> $GITHUB_OUTPUT

  patch-apps:
    name: Read Configuration 
    needs: [check-updates, download-tools]
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-matrix.outputs.matrix }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Cached Tools
        uses: actions/cache@v3
        with:
          path: tools/
          key: revanced-tools-${{ hashFiles('patch-config.json') }}

      - name: Read Patch Config
        id: read-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './patch-config.json';
            const matrix = JSON.parse(fs.readFileSync(path, 'utf8')).patch_list;
            core.setOutput("matrix", JSON.stringify(matrix));

  build-apps:
    name: Build Applications
    needs: [patch-apps, download-tools]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 5  # Limit parallel jobs to avoid rate limits
      matrix:
        include: ${{ fromJson(needs.patch-apps.outputs.matrix) }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Restore Cached Tools
        uses: actions/cache@v3
        with:
          path: tools/
          key: revanced-tools-${{ hashFiles('patch-config.json') }}

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install Dependencies
        run: |
          pip install -r requirements.txt
          pip install requests beautifulsoup4

      - name: Build APK
        env:
          APP_NAME: ${{ matrix.app_name }}
          SOURCE: ${{ matrix.source }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Building ${{ matrix.app_name }} with ${{ matrix.source }}..."
          
          # Add delay to avoid rate limits (stagger the builds)
          sleep $((RANDOM % 30)).$((RANDOM % 100))
          
          python -m src
      
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.app_name }}-${{ matrix.source }}
          path: "*.apk"

# ... rest of your workflow (create-release, cleanup) stays the same
