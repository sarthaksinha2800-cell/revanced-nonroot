name: Auto Patch and Release ReVanced

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  push:
    branches: [ main ]
    paths:
      - 'patch-config.json'
      - 'apps/**'
      - '.github/workflows/patch.yml'

jobs:
  check-updates:
    name: Check for Updates
    runs-on: ubuntu-latest
    outputs:
      has_updates: ${{ steps.check.outputs.has_updates }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install Python Dependencies
        run: |
          pip install requests
      
      - name: Check for App Updates
        id: check
        run: |
          echo "Checking for app updates..."
          # Install requests module
          pip install requests
          # Run update checker from repository root
          python scripts/check_updates.py
          
          # Check if any files were modified
          if git diff --name-only | grep -q '\.json$'; then
            echo "Updates found"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          else
            echo "No updates found"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi

  patch-apps:
    name: Read Matrix Configuration 
    needs: check-updates
    if: needs.check-updates.outputs.has_updates == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.read-matrix.outputs.matrix }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Read Matrix Config
        id: read-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = './patch-config.json';
            const matrix = JSON.parse(fs.readFileSync(path, 'utf8')).patch_list;
            core.setOutput("matrix", JSON.stringify(matrix));

  matrix-patch:
    name: Patch Applications
    needs: patch-apps
    permissions: 
      contents: write
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      ENDPOINT_URL: ${{ secrets.ENDPOINT_URL }}
      BUCKET_NAME: ${{ secrets.BUCKET_NAME }}
    
    strategy:
      matrix:
        include: ${{ fromJson(needs.patch-apps.outputs.matrix) }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Patch Application 
        env:
          APP_NAME: ${{ matrix.app_name }}
          SOURCE: ${{ matrix.source }}
        run: python -m src
      
      - name: Find and Rename APK Files
        run: |
          # Find APK files and rename them with source and timestamp
          for apk_file in *.apk; do
            if [ -f "$apk_file" ]; then
              timestamp=$(date +%Y%m%d-%H%M)
              new_name="revanced-${{ matrix.app_name }}-${{ matrix.source }}-${timestamp}.apk"
              mv "$apk_file" "$new_name"
              echo "Renamed: $apk_file -> $new_name"
            fi
          done
      
      - name: Upload APKs to Cloudflare R2
        if: success()
        run: |
          # This will use your existing R2 upload logic
          # Assuming your src module handles R2 upload
          echo "APKs should be uploaded to R2 by the patching script"
      
      - name: Upload APKs as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: revanced-apks-${{ matrix.app_name }}-${{ matrix.source }}
          path: "*.apk"
          retention-days: 1

  create-release:
    name: Create GitHub Release
    needs: matrix-patch
    if: success()
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Download All APK Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./apks
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Generate Release Notes
        run: |
          python scripts/manage_release.py
      
      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: revanced-$(date +%Y%m%d-%H%M)
          name: "ReVanced APKs - $(date +'%Y-%m-%d %H:%M')"
          body_path: release_notes.md
          files: |
            ./apks/**/*.apk
          draft: false
          prerelease: false
          generate_release_notes: false
      
      - name: Clean Old Releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Install GitHub CLI if needed
          if ! command -v gh &> /dev/null; then
            echo "Installing GitHub CLI..."
            type -p curl >/dev/null || (apt-get update && apt-get install curl -y)
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            apt-get update
            apt-get install gh -y
          fi
          
          # Keep only last 3 releases
          releases=$(gh release list --repo $GITHUB_REPOSITORY --limit 20 --json tagName,isDraft)
          
          # Filter for auto-generated releases and sort by date
          auto_releases=$(echo "$releases" | jq -r '.[] | select(.tagName | startswith("revanced-")) | .tagName' | sort -r)
          
          # Count releases
          count=0
          to_delete=""
          for release in $auto_releases; do
            if [ $count -ge 3 ]; then
              to_delete="$to_delete $release"
            fi
            count=$((count + 1))
          done
          
          # Delete old releases
          for release in $to_delete; do
            echo "Deleting old release: $release"
            gh release delete "$release" --yes --repo $GITHUB_REPOSITORY || true
          done

  cleanup:
    name: Cleanup Workflow Runs
    needs: matrix-patch
    runs-on: ubuntu-latest
    if: ${{ always() }}
    permissions:
      actions: write
    steps:
    - name: Cleanup Previous Workflow Runs
      uses: actions/github-script@v7
      with:
        script: |
          const { data: runs } = await github.rest.actions.listWorkflowRuns({
            owner: context.repo.owner,
            repo: context.repo.repo,
            workflow_id: 'patch.yml',
            per_page: 100,
            status: 'completed'
          });

          console.log(`Found ${runs.total_count} workflow runs.`);

          // Keep last 5 runs, delete older ones
          const runsToDelete = runs.workflow_runs
            .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
            .slice(5);

          for (const run of runsToDelete) {
            console.log(`Deleting workflow run ID: ${run.id} (${run.created_at})`);
            try {
              await github.rest.actions.deleteWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                run_id: run.id,
              });
            } catch (error) {
              console.log(`Failed to delete run ${run.id}: ${error.message}`);
            }
          }
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
